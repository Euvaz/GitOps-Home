---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: keycloak
  namespace: security
spec:
  interval: 15m
  chart:
    spec:
      chart: keycloakx
      version: 2.2.1
      sourceRef:
        kind: HelmRepository
        name: codecentric
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  values:
    image:
      repository: quay.io/keycloak/keycloak
      tag: 21.1.1
      digest: sha256:8ebb3930c41e8a066c4246eaf351ac09cdc984e11b1f607d6ff4ce10d69dc808
    command:
      - "/opt/keycloak/bin/kc.sh"
    args:
      - "start"
    extraEnv: |-
      - name: TZ
        value: "${TIMEZONE}"
      - name: JAVA_OPTS_APPEND
        value: "-Djgroups.dns.query=keycloak-headless"
      - name: KC_PROXY
        value: "edge"
      - name: KC_HTTP_ENABLED
        value: "true"
      - name: KC_HOSTNAME
        value: "id.${SECRET_DOMAIN}"
      - name: KC_HOSTNAME_STRICT
        value: "true"
      - name: KC_HOSTNAME_STRICT_HTTPS
        value: "true"
      - name: KC_LOG_LEVEL
        value: "org.keycloak.events:DEBUG,org.infinispan:INFO,org.jgroups:INFO"
      - name: KEYCLOAK_ADMIN
        value: "admin"
      - name: KEYCLOAK_ADMIN_PASSWORD
        value: "${SECRET_KEYCLOAK_ADMIN_PASSWORD}"
    ingress:
      enabled: true
      ingressClassName: "traefik"
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-production"
        traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
        gethomepage.dev/enabled: "true"
        gethomepage.dev/name: "Keycloak"
        gethomepage.dev/group: "Security"
        gethomepage.dev/icon: "keycloak"
        gethomepage.dev/description: "Open Source Identity and Access Management."
      hosts:
        - host: &host "id.${SECRET_DOMAIN}"
          paths:
            - path: /
              type: Prefix
      tls:
        - hosts:
            - *host
          secretName: id-tls
    database:
      vendor: postgres
      hostname: postgresql.database.svc.cluster.local
      port: 5432
      database: keycloak
      username: keycloak
      password: ${SECRET_KEYCLOAK_DATABASE_PASSWORD}
    proxy:
      enabled: false
    prometheusRule:
      enabled: true
